<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Scratch Song Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ===== RESET & BASE ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Roboto', sans-serif; background: #121212; color: #fff; min-height: 100vh; padding: 40px; display: flex; flex-direction: column; align-items: center; transition: background 0.5s; }
h2 { font-size: 2rem; margin-bottom: 20px; color: #1DB954; text-shadow: 0 2px 6px rgba(0,0,0,0.5); }

/* ===== SEARCH BAR ===== */
#search-bar { width: 300px; padding: 12px 16px; border-radius: 30px; border: none; outline: none; font-size: 1rem; transition: all 0.3s; margin-right: 10px; background: #1e1e1e; color: #fff; }
#search-bar::placeholder { color: #888; }
#search-bar:focus { box-shadow: 0 0 12px #1DB954; }

/* ===== BUTTON ===== */
button { padding: 12px 20px; border: none; border-radius: 30px; background: #1DB954; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; }
button:hover { background: #1ed760; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

/* ===== SONG GRID ===== */
#song-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; margin-top: 30px; }

/* ===== SONG CARD ===== */
.song-card { background: #1e1e1e; border-radius: 15px; overflow: hidden; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; text-align: center; padding-bottom: 10px; }
.song-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,219,84,0.4); }

.song-card img { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; margin-top: 10px; transition: transform 0.3s; }
.song-card img:hover { transform: scale(1.05); }

.song-name { font-size: 14px; font-weight: 700; margin-top: 8px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.artist-name { font-size: 12px; color: #b3b3b3; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* ===== RESPONSIVE ===== */
@media (max-width: 500px) {
  #search-bar { width: 70%; margin-bottom: 10px; }
  button { width: 70%; }
}
</style>
</head>
<body>

<h2>ðŸŽµ Scratch Song Builder</h2>

<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; width:100%; max-width:400px;">
  <input type="text" id="search-bar" placeholder="Search songs or artists">
  <button onclick="searchSongs()">Search</button>
</div>

<div id="song-grid"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
// ===== PURE JS MD5 =====
function md5(buffer) {
  function rhex(n){let s="";for(let j=0;j<4;j++)s+=("0"+((n>>(j*8))&255).toString(16)).slice(-2);return s;}
  function cmn(q,a,b,x,s,t){a=(a+q+x+t)&0xffffffff;return(((a<<s)|(a>>>(32-s)))+b)&0xffffffff;}
  function ff(a,b,c,d,x,s,t){return cmn((b&c)|(~b&d),a,b,x,s,t);}
  function gg(a,b,c,d,x,s,t){return cmn((b&d)|(c&~d),a,b,x,s,t);}
  function hh(a,b,c,d,x,s,t){return cmn(b^c^d,a,b,x,s,t);}
  function ii(a,b,c,d,x,s,t){return cmn(c^(b|~d),a,b,x,s,t);}
  function md5cycle(x,k){let[a,b,c,d]=x;a=ff(a,b,c,d,k[0],7,-680876936);d=ff(d,a,b,c,k[1],12,-389564586);c=ff(c,d,a,b,k[2],17,606105819);b=ff(b,c,d,a,k[3],22,-1044525330);a=gg(a,b,c,d,k[4],5,-176418897);d=gg(d,a,b,c,k[5],9,1200080426);c=gg(c,d,a,b,k[6],14,-1473231341);b=gg(b,c,d,a,k[7],20,-45705983);a=hh(a,b,c,d,k[8],4,1770035416);d=hh(d,a,b,c,k[9],11,-1958414417);c=hh(c,d,a,b,k[10],16,-42063);b=hh(b,c,d,a,k[11],23,-1990404162);a=ii(a,b,c,d,k[12],6,1804603682);d=ii(d,a,b,c,k[13],10,-40341101);c=ii(c,d,a,b,k[14],15,-1502002290);b=ii(b,c,d,a,k[15],21,1236535329);x[0]=(x[0]+a)&0xffffffff;x[1]=(x[1]+b)&0xffffffff;x[2]=(x[2]+c)&0xffffffff;x[3]=(x[3]+d)&0xffffffff;}
  const bytes=new Uint8Array(buffer),data=[];for(let i=0;i<bytes.length;i++)data[i>>2]|=bytes[i]<<((i%4)*8);data[bytes.length>>2]|=0x80<<((bytes.length%4)*8);data[((bytes.length+8)>>6)*16+14]=bytes.length*8;const x=[1732584193,-271733879,-1732584194,271733878];for(let i=0;i<data.length;i+=16)md5cycle(x,data.slice(i,i+16));return x.map(rhex).join("");
}

// ===== Search songs using iTunes API =====
async function searchSongs() {
  const term = document.getElementById("search-bar").value;
  if(!term) return;
  const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=music&limit=20`);
  const data = await res.json();

  const grid = document.getElementById("song-grid");
  grid.innerHTML = "";
  
  data.results.forEach(song => {
    if(!song.previewUrl || !song.artworkUrl100) return;
    const card = document.createElement("div");
    card.className = "song-card";
    card.innerHTML = `
      <img src="${song.artworkUrl100}" alt="Cover art"/>
      <div class="song-name">${song.trackName}</div>
      <div class="artist-name">${song.artistName}</div>
    `;
    card.onclick = () => generateSB3(song.previewUrl, song.artworkUrl100, song.trackName);
    grid.appendChild(card);
  });
}

// ===== Generate SB3 =====
async function generateSB3(audioUrl, coverUrl, songName) {
  try {
    const res = await fetch("song.sb3");
    if(!res.ok) throw "Could not fetch song.sb3 from same folder";
    const sb3Bytes = await res.arrayBuffer();
    const zip = await JSZip.loadAsync(sb3Bytes);
    const project = JSON.parse(await zip.file("project.json").async("text"));
    const sprite = project.targets.find(t => !t.isStage && t.sounds?.length);
    if(!sprite) throw "No sound sprite found";

    const audioRes = await fetch(audioUrl);
    const audioBuf = await audioRes.arrayBuffer();
    const audioHash = md5(audioBuf);
    Object.assign(sprite.sounds[0], { assetId: audioHash, md5ext: `${audioHash}.mp3`, dataFormat: "mp3" });
    zip.file(`${audioHash}.mp3`, audioBuf);

    const imgRes = await fetch(coverUrl);
    const imgBuf = await imgRes.arrayBuffer();
    const imgExt = coverUrl.split('.').pop().split('?')[0];
    const imgHash = md5(imgBuf);
    Object.assign(sprite.costumes[0], { assetId: imgHash, md5ext: `${imgHash}.${imgExt}`, dataFormat: imgExt });
    zip.file(`${imgHash}.${imgExt}`, imgBuf);

    zip.file("project.json", JSON.stringify(project, null, 2));
    const safeName = songName.replace(/[\/\\:*?"<>|]/g, "_");

    saveAs(await zip.generateAsync({type:"blob"}), `${safeName}.sb3`);
  } catch(e) {
    alert("ERROR: " + e);
    console.error(e);
  }
}
</script>
</body>
</html>
